#!/bin/bash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SEPOLIA RPC MANAGER - Fast Setup with Geth & Prysm
# Version: 3.0 - Universal (Works for both root and non-root users)
# Description: Complete RPC node management (Debian/Ubuntu compatible)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Color definitions
CYAN='\033[0;36m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
WHITE='\033[1;37m'
AMBER='\033[0;33m'
PURPLE='\033[0;35m'
NC='\033[0m'
BOLD='\033[1m'
DIM='\033[2m'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# USER DETECTION AND CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

setup_user_config() {
    if [ "$EUID" -eq 0 ]; then
        # Running as root
        RPC_DIR="/root/ethereum"
        USER_TYPE="root"
        DOCKER_CMD="docker"
        SUDO_CMD=""
    else
        # Running as regular user
        RPC_DIR="$HOME/ethereum"
        USER_TYPE="$USER"
        
        # Check if user is in docker group
        if groups | grep -q docker; then
            DOCKER_CMD="docker"
            echo -e "${GREEN}âœ… You're in docker group - good!${NC}"
        else
            DOCKER_CMD="sudo docker"
            echo -e "${YELLOW}âš ï¸  You're not in docker group. Docker commands will use sudo.${NC}"
            echo -e "${CYAN}To fix this (recommended), run:${NC}"
            echo -e "${WHITE}sudo usermod -aG docker $USER${NC}"
            echo -e "${WHITE}newgrp docker${NC}"
            echo -e "${CYAN}Or logout and login again after adding to group.${NC}"
            sleep 3
        fi
        SUDO_CMD="sudo"
    fi
    
    # Export for use in functions
    export RPC_DIR
    export USER_TYPE
    export DOCKER_CMD
    export SUDO_CMD
}

# Call setup at script start
setup_user_config

# Configuration
GETH_PORT=8545
WS_PORT=8546
BEACON_PORT=3500

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# HELPER FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

install_docker() {
    if ! command -v docker &> /dev/null; then
        echo -e "${YELLOW}Installing Docker...${NC}"
        
        # Check if Ubuntu or Debian
        if [ ! -f /etc/os-release ]; then
            echo -e "${RED}Not Ubuntu or Debian${NC}"
            exit 1
        fi
        
        # Update system
        ${SUDO_CMD} apt update -y && ${SUDO_CMD} apt upgrade -y
        
        # Install prerequisites
        ${SUDO_CMD} apt-get update
        ${SUDO_CMD} apt-get install -y ca-certificates curl gnupg lsb-release
        ${SUDO_CMD} install -m 0755 -d /etc/apt/keyrings
        
        # Add Docker's official GPG key
        . /etc/os-release
        repo_url="https://download.docker.com/linux/$ID"
        curl -fsSL "$repo_url/gpg" | ${SUDO_CMD} gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        ${SUDO_CMD} chmod a+r /etc/apt/keyrings/docker.gpg
        
        # Set up the repository
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] $repo_url $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
          ${SUDO_CMD} tee /etc/apt/sources.list.d/docker.list > /dev/null
        
        # Install Docker
        ${SUDO_CMD} apt update -y
        ${SUDO_CMD} apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
        
        # Add current user to docker group if not root
        if [ "$EUID" -ne 0 ]; then
            ${SUDO_CMD} usermod -aG docker $USER
            echo -e "${YELLOW}Added $USER to docker group. Please logout and login again.${NC}"
        fi
        
        # Test Docker installation
        if ${SUDO_CMD} docker run hello-world >/dev/null 2>&1; then
            ${SUDO_CMD} docker rm $(${SUDO_CMD} docker ps -a --filter "ancestor=hello-world" --format "{{.ID}}") --force 2>/dev/null || true
            ${SUDO_CMD} docker image rm hello-world 2>/dev/null || true
            ${SUDO_CMD} systemctl enable docker
            ${SUDO_CMD} systemctl restart docker
            echo -e "${GREEN}âœ… Docker Installed Successfully${NC}"
        else
            echo -e "${RED}âŒ Docker installation failed${NC}"
            exit 1
        fi
    else
        echo -e "${GREEN}âœ… Docker is already installed${NC}"
    fi
}

check_docker() {
    if ! command -v docker &> /dev/null; then
        install_docker
    fi
}

get_public_ip() {
    curl -s ipv4.icanhazip.com 2>/dev/null || \
    curl -s ifconfig.me 2>/dev/null || \
    curl -s api.ipify.org 2>/dev/null || \
    echo "localhost"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

install_rpc() {
    clear
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘        ğŸš€ INSTALL SEPOLIA RPC (GETH & PRYSM)         â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    echo -e "${WHITE}Running as: ${GREEN}$USER_TYPE${NC}"
    echo -e "${WHITE}Install directory: ${GREEN}$RPC_DIR${NC}"
    echo ""
    
    # Check minimum requirements
    RAM_GB=$(($(grep MemTotal /proc/meminfo | awk '{print $2}') / 1024 / 1024))
    CORES=$(nproc)
    STORAGE_GB=$(df -BG ~ | awk 'NR==2 {print $4}' | sed 's/G//')
    
    if [ "$RAM_GB" -lt 8 ] || [ "$CORES" -lt 2 ]; then
        echo -e "${RED}âš ï¸  Your VPS does not meet minimum requirements${NC}"
        echo -e "${WHITE}Current: RAM ${RAM_GB}GB, Cores ${CORES}${NC}"
        echo -e "${WHITE}Required: RAM 8GB+, Cores 2+${NC}"
        read -p "Continue anyway? (y/N): " cont
        if [[ ! "$cont" =~ ^[Yy]$ ]]; then
            return
        fi
    fi
    
    # Check if already installed
    if [ -d "$RPC_DIR" ] && [ -f "$RPC_DIR/docker-compose.yml" ]; then
        echo -e "${YELLOW}âš ï¸  RPC already installed at $RPC_DIR${NC}"
        read -p "Do you want to reinstall? (y/N): " reinstall
        if [[ ! "$reinstall" =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}Installation cancelled${NC}"
            read -p "Press Enter to continue..."
            return
        fi
        
        # Stop existing containers
        echo -ne "${CYAN}Stopping existing containers...${NC}"
        cd "$RPC_DIR" 2>/dev/null || true
        $DOCKER_CMD compose down 2>/dev/null || $DOCKER_CMD-compose down 2>/dev/null || true
        cd ~ 2>/dev/null || true
        echo -e " ${GREEN}âœ“${NC}"
    fi
    
    # Install dependencies
    echo -ne "${CYAN}Installing dependencies...${NC}"
    ${SUDO_CMD} apt update >/dev/null 2>&1
    ${SUDO_CMD} apt install -y wget lz4 aria2 docker-compose-plugin docker-compose openssl >/dev/null 2>&1
    echo -e " ${GREEN}âœ“${NC}"
    
    # Create directories
    echo -ne "${CYAN}Creating directories...${NC}"
    mkdir -p "$RPC_DIR/execution" 2>/dev/null || {
        echo -e " ${RED}âœ—${NC}"
        echo -e "${RED}Failed to create directories in $RPC_DIR${NC}"
        read -p "Press Enter to continue..."
        return
    }
    mkdir -p "$RPC_DIR/consensus"
    chmod 755 "$RPC_DIR"
    cd "$RPC_DIR" || {
        echo -e "${RED}Failed to access $RPC_DIR${NC}"
        read -p "Press Enter to continue..."
        return
    }
    echo -e " ${GREEN}âœ“${NC}"
    
    # Generate JWT secret
    echo -ne "${CYAN}Generating JWT secret...${NC}"
    openssl rand -hex 32 > "$RPC_DIR/jwt.hex" 2>/dev/null || {
        echo -e " ${RED}âœ—${NC}"
        echo -e "${RED}Failed to generate JWT secret${NC}"
        read -p "Press Enter to continue..."
        return
    }
    chmod 644 "$RPC_DIR/jwt.hex"
    echo -e " ${GREEN}âœ“${NC}"
    
    # Create docker-compose.yml with dynamic paths
    echo -ne "${CYAN}Creating Docker configuration...${NC}"
    cat > docker-compose.yml << EOF
services:
    geth:
        image: ethereum/client-go:v1.16.4
        container_name: geth
        network_mode: host
        restart: unless-stopped
        volumes:
            - $RPC_DIR/execution:/data
            - $RPC_DIR/jwt.hex:/data/jwt.hex
        command:
            - --sepolia
            - --http
            - --http.api=eth,net,web3
            - --http.addr=0.0.0.0
            - --authrpc.addr=0.0.0.0
            - --authrpc.vhosts=*
            - --authrpc.jwtsecret=/data/jwt.hex
            - --authrpc.port=8551
            - --syncmode=snap
            - --datadir=/data
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"

    prysm:
        image: gcr.io/prysmaticlabs/prysm/beacon-chain:v6.1.2
        container_name: prysm
        network_mode: host
        restart: unless-stopped
        volumes:
            - $RPC_DIR/consensus:/data
            - $RPC_DIR/jwt.hex:/data/jwt.hex
        depends_on:
            - geth
        command:
            - --sepolia
            - --accept-terms-of-use
            - --datadir=/data
            - --disable-monitoring
            - --rpc-host=0.0.0.0
            - --execution-endpoint=http://127.0.0.1:8551
            - --jwt-secret=/data/jwt.hex
            - --rpc-port=4000
            - --grpc-gateway-corsdomain=*
            - --grpc-gateway-host=0.0.0.0
            - --grpc-gateway-port=3500
            - --min-sync-peers=3
            - --checkpoint-sync-url=https://checkpoint-sync.sepolia.ethpandaops.io
            - --genesis-beacon-api-url=https://checkpoint-sync.sepolia.ethpandaops.io
            - --subscribe-all-data-subnets
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
EOF
    echo -e " ${GREEN}âœ“${NC}"
    
    # Start services
    echo -ne "${CYAN}Starting RPC services...${NC}"
    if $DOCKER_CMD compose up -d >/dev/null 2>&1; then
        echo -e " ${GREEN}âœ“${NC}"
    elif $DOCKER_CMD-compose up -d >/dev/null 2>&1; then
        echo -e " ${GREEN}âœ“${NC}"
    else
        echo -e " ${RED}âœ—${NC}"
        echo -e "${RED}Failed to start services${NC}"
        echo -e "${YELLOW}Showing last 20 lines of logs:${NC}"
        $DOCKER_CMD compose logs --tail 20 2>/dev/null || $DOCKER_CMD-compose logs --tail 20 2>/dev/null || true
        read -p "Press Enter to continue..."
        return
    fi
    
    # Configure firewall
    echo -ne "${CYAN}Configuring firewall...${NC}"
    ${SUDO_CMD} ufw allow 22/tcp >/dev/null 2>&1
    ${SUDO_CMD} ufw allow $GETH_PORT/tcp >/dev/null 2>&1
    ${SUDO_CMD} ufw allow $WS_PORT/tcp >/dev/null 2>&1
    ${SUDO_CMD} ufw allow $BEACON_PORT/tcp >/dev/null 2>&1
    ${SUDO_CMD} ufw allow 30303/tcp >/dev/null 2>&1
    ${SUDO_CMD} ufw allow 30303/udp >/dev/null 2>&1
    ${SUDO_CMD} ufw allow 4000/tcp >/dev/null 2>&1
    
    if ${SUDO_CMD} ufw status 2>/dev/null | grep -q "Status: inactive"; then
        echo "y" | ${SUDO_CMD} ufw enable >/dev/null 2>&1
    fi
    echo -e " ${GREEN}âœ“${NC}"
    
    # Get IP
    VPS_IP=$(get_public_ip)
    
    # Final message
    echo -e "\n${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘              âœ… RPC INSTALLATION COMPLETE             â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${CYAN}ğŸ“Š RPC Endpoints:${NC}"
    echo -e "  ${WHITE}â€¢ HTTP RPC:${NC} ${YELLOW}http://$VPS_IP:$GETH_PORT${NC}"
    echo -e "  ${WHITE}â€¢ WebSocket:${NC} ${YELLOW}ws://$VPS_IP:$WS_PORT${NC}"
    echo -e "  ${WHITE}â€¢ Beacon API:${NC} ${YELLOW}http://$VPS_IP:$BEACON_PORT${NC}"
    echo ""
    echo -e "${WHITE}Installed in: ${GREEN}$RPC_DIR${NC}"
    echo -e "${YELLOW}â³ Sync time: 6-8 hours depending on your VPS specs${NC}"
    echo -e "\n${CYAN}Use option 2 to check sync progress${NC}"
    read -p "Press Enter to continue..."
}

check_sync() {
    clear
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘              ğŸ“Š RPC SYNC STATUS CHECK                 â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # Check if RPC is installed
    if [ ! -d "$RPC_DIR" ]; then
        echo -e "${RED}âŒ RPC not installed at $RPC_DIR${NC}"
        echo -e "${YELLOW}Please install first (Option 1)${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    cd "$RPC_DIR" 2>/dev/null || return
    
    # Check if containers are running
    if ! $DOCKER_CMD ps | grep -q "geth"; then
        echo -e "${RED}âŒ Geth container is not running${NC}"
        echo -e "${YELLOW}Starting containers...${NC}"
        $DOCKER_CMD compose up -d 2>/dev/null || $DOCKER_CMD-compose up -d 2>/dev/null
        sleep 5
    fi
    
    echo -e "${CYAN}Checking sync status...${NC}\n"
    
    # Check Geth sync
    echo -e "${WHITE}â•â•â•[ GETH STATUS ]â•â•â•${NC}"
    GETH_SYNC=$(curl -s -X POST -H "Content-Type: application/json" \
        --data '{"jsonrpc":"2.0","method":"eth_syncing","params":[],"id":1}' \
        http://localhost:$GETH_PORT 2>/dev/null)
    
    if [ -z "$GETH_SYNC" ]; then
        echo -e "${RED}âŒ Cannot connect to Geth RPC${NC}"
    elif echo "$GETH_SYNC" | grep -q '"result":false'; then
        echo -e "${GREEN}âœ… Geth is fully synced${NC}"
        
        # Get current block
        BLOCK=$(curl -s -X POST -H "Content-Type: application/json" \
            --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' \
            http://localhost:$GETH_PORT | grep -Po '"result":"\K[^"]*')
        
        if [ ! -z "$BLOCK" ]; then
            BLOCK_DEC=$((16#${BLOCK#0x}))
            echo -e "  ${WHITE}Current block:${NC} ${GREEN}$BLOCK_DEC${NC}"
        fi
    else
        echo -e "${YELLOW}â³ Geth is syncing...${NC}"
        
        CURRENT=$(echo "$GETH_SYNC" | grep -Po '"currentBlock":"\K[^"]*')
        HIGHEST=$(echo "$GETH_SYNC" | grep -Po '"highestBlock":"\K[^"]*')
        
        if [ ! -z "$CURRENT" ] && [ ! -z "$HIGHEST" ]; then
            CURRENT_DEC=$((16#${CURRENT#0x}))
            HIGHEST_DEC=$((16#${HIGHEST#0x}))
            
            if [ $HIGHEST_DEC -gt 0 ]; then
                PROGRESS=$(awk "BEGIN {printf \"%.2f\", ($CURRENT_DEC/$HIGHEST_DEC)*100}")
                echo -e "  ${WHITE}Progress:${NC} ${YELLOW}${PROGRESS}%${NC}"
                echo -e "  ${WHITE}Current Block:${NC} $CURRENT_DEC"
                echo -e "  ${WHITE}Target Block:${NC} $HIGHEST_DEC"
                
                # Get ETA from Geth logs
                ETA=$($DOCKER_CMD logs geth --tail 20 2>&1 | grep -oP 'eta=\K[^ ]+' | tail -1)
                if [ ! -z "$ETA" ]; then
                    echo -e "  ${WHITE}Estimated time:${NC} ${YELLOW}${ETA}${NC}"
                fi
            fi
        fi
    fi
    
    # Check Prysm sync
    echo -e "\n${WHITE}â•â•â•[ PRYSM BEACON STATUS ]â•â•â•${NC}"
    BEACON_SYNC=$(curl -s http://localhost:$BEACON_PORT/eth/v1/node/syncing 2>/dev/null)
    
    if [ -z "$BEACON_SYNC" ]; then
        echo -e "${RED}âŒ Cannot connect to Prysm Beacon${NC}"
    elif echo "$BEACON_SYNC" | grep -q '"is_syncing":false'; then
        echo -e "${GREEN}âœ… Beacon is fully synced${NC}"
    else
        echo -e "${YELLOW}â³ Beacon is syncing...${NC}"
        SYNC_DISTANCE=$(echo "$BEACON_SYNC" | grep -Po '"sync_distance":"\K[^"]*')
        if [ ! -z "$SYNC_DISTANCE" ]; then
            echo -e "  ${WHITE}Slots behind:${NC} ${YELLOW}$SYNC_DISTANCE${NC}"
        fi
    fi
    
    # Overall status
    echo -e "\n${WHITE}â•â•â•[ OVERALL STATUS ]â•â•â•${NC}"
    
    GETH_SYNCED=false
    BEACON_SYNCED=false
    
    if echo "$GETH_SYNC" | grep -q '"result":false'; then
        GETH_SYNCED=true
    fi
    
    if echo "$BEACON_SYNC" | grep -q '"is_syncing":false'; then
        BEACON_SYNCED=true
    fi
    
    if [ "$GETH_SYNCED" = true ] && [ "$BEACON_SYNCED" = true ]; then
        VPS_IP=$(get_public_ip)
        echo -e "${GREEN}âœ… RPC is fully synced and ready to use${NC}"
        echo -e "\n${CYAN}Your RPC URLs:${NC}"
        echo -e "${YELLOW}HTTP: http://$VPS_IP:$GETH_PORT${NC}"
        echo -e "${YELLOW}Beacon: http://$VPS_IP:$BEACON_PORT${NC}"
    else
        echo -e "${YELLOW}â³ RPC is still syncing. Please wait...${NC}"
    fi
    
    read -p "Press Enter to continue..."
}

view_rpc() {
    clear
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘                 ğŸ“œ RPC CONNECTION INFO                â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    if [ ! -d "$RPC_DIR" ]; then
        echo -e "${RED}âŒ RPC not installed at $RPC_DIR${NC}"
        echo -e "${YELLOW}Please install first (Option 1)${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    VPS_IP=$(get_public_ip)
    
    echo -e "${YELLOW}â•â•â•[ RPC & AZTEC ON SAME VPS ]â•â•â•${NC}"
    echo -e "${WHITE}Use these URLs in your Aztec configuration:${NC}"
    echo -e "  ${CYAN}â€¢ Sepolia RPC:${NC} ${GREEN}http://localhost:8545${NC}"
    echo -e "  ${CYAN}â€¢ Beacon RPC:${NC}  ${GREEN}http://localhost:3500${NC}"
    
    echo -e "\n${YELLOW}â•â•â•[ RPC & AZTEC ON SEPARATE VPS ]â•â•â•${NC}"
    echo -e "${WHITE}Use these URLs in your Aztec configuration:${NC}"
    echo -e "  ${CYAN}â€¢ Sepolia RPC:${NC} ${GREEN}http://$VPS_IP:8545${NC}"
    echo -e "  ${CYAN}â€¢ Beacon RPC:${NC}  ${GREEN}http://$VPS_IP:3500${NC}"
    
    echo -e "\n${WHITE}RPC Installation Directory: ${GREEN}$RPC_DIR${NC}"
    
    echo -e "\n${AMBER}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    
    cd "$RPC_DIR" 2>/dev/null || return
    
    echo -e "\n${CYAN}View logs?${NC}"
    echo -e "  ${WHITE}1)${NC} Geth logs"
    echo -e "  ${WHITE}2)${NC} Prysm logs"
    echo -e "  ${WHITE}3)${NC} Both logs"
    echo -e "  ${WHITE}4)${NC} Back to menu"
    
    read -p "Choose option [1-4]: " log_choice
    
    case $log_choice in
        1)
            echo -e "\n${CYAN}Showing Geth logs (Press Ctrl+C to exit)...${NC}\n"
            $DOCKER_CMD logs geth --tail 100 -f 2>&1 || true
            ;;
        2)
            echo -e "\n${CYAN}Showing Prysm logs (Press Ctrl+C to exit)...${NC}\n"
            $DOCKER_CMD logs prysm --tail 100 -f 2>&1 || true
            ;;
        3)
            echo -e "\n${CYAN}Showing all logs (Press Ctrl+C to exit)...${NC}\n"
            $DOCKER_CMD compose logs --tail 100 -f 2>&1 || $DOCKER_CMD-compose logs --tail 100 -f 2>&1 || true
            ;;
        4)
            return
            ;;
        *)
            echo -e "${RED}Invalid option${NC}"
            sleep 1
            ;;
    esac
}

delete_rpc() {
    clear
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘            âš ï¸  DELETE RPC NODE WARNING âš ï¸              â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    if [ ! -d "$RPC_DIR" ]; then
        echo -e "${YELLOW}RPC is not installed at $RPC_DIR${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    echo -e "${YELLOW}This will delete:${NC}"
    echo -e "  ${WHITE}â€¢ Geth container and data${NC}"
    echo -e "  ${WHITE}â€¢ Prysm container and data${NC}"
    echo -e "  ${WHITE}â€¢ All synced blockchain data${NC}"
    echo -e "  ${WHITE}â€¢ Directory: $RPC_DIR${NC}"
    echo ""
    echo -e "${RED}âš ï¸  This action cannot be undone${NC}"
    read -p "Are you sure? [y/N]: " confirm
    
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        echo ""
        cd "$RPC_DIR" 2>/dev/null || cd ~ || return
        
        # Stop containers
        echo -ne "${CYAN}Stopping containers...${NC}"
        $DOCKER_CMD compose down 2>/dev/null || $DOCKER_CMD-compose down 2>/dev/null || true
        $DOCKER_CMD stop geth prysm 2>/dev/null || true
        echo -e " ${GREEN}âœ“${NC}"
        
        # Remove containers
        echo -ne "${CYAN}Removing containers...${NC}"
        $DOCKER_CMD rm geth prysm 2>/dev/null || true
        echo -e " ${GREEN}âœ“${NC}"
        
        # Remove images
        echo -ne "${CYAN}Removing Docker images...${NC}"
        $DOCKER_CMD rmi ethereum/client-go:v1.16.4 2>/dev/null || true
        $DOCKER_CMD rmi gcr.io/prysmaticlabs/prysm/beacon-chain:v6.1.2 2>/dev/null || true
        echo -e " ${GREEN}âœ“${NC}"
        
        # Remove data
        echo -ne "${CYAN}Removing RPC data...${NC}"
        cd ~ || return
        rm -rf "$RPC_DIR" 2>/dev/null || true
        echo -e " ${GREEN}âœ“${NC}"
        
        # Remove firewall rules
        echo -ne "${CYAN}Cleaning firewall rules...${NC}"
        ${SUDO_CMD} ufw delete allow 8545/tcp 2>/dev/null || true
        ${SUDO_CMD} ufw delete allow 8546/tcp 2>/dev/null || true
        ${SUDO_CMD} ufw delete allow 3500/tcp 2>/dev/null || true
        ${SUDO_CMD} ufw delete allow 4000/tcp 2>/dev/null || true
        ${SUDO_CMD} ufw delete allow 30303/tcp 2>/dev/null || true
        ${SUDO_CMD} ufw delete allow 30303/udp 2>/dev/null || true
        echo -e " ${GREEN}âœ“${NC}"
        
        echo -e "\n${GREEN}âœ… RPC Node completely deleted from $RPC_DIR${NC}"
    else
        echo -e "\n${CYAN}âŒ Deletion cancelled${NC}"
    fi
    
    read -p "Press Enter to continue..."
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN MENU FUNCTION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

main_menu() {
    while true; do
        clear
        
        # Re-check user config in case permissions changed
        setup_user_config
        
        # Get system specs
        RAM_GB=$(($(grep MemTotal /proc/meminfo | awk '{print $2}') / 1024 / 1024))
        CORES=$(nproc)
        STORAGE_GB=$(df -BG ~ | awk 'NR==2 {print $2}' | sed 's/G//')
        STORAGE_FREE=$(df -BG ~ | awk 'NR==2 {print $4}' | sed 's/G//')
        
        echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${CYAN}â•‘          ğŸŒ SEPOLIA RPC NODE MANAGER                  â•‘${NC}"
        echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${WHITE}    Fast Ethereum Sepolia RPC with Geth & Prysm${NC}"
        echo -e "${AMBER}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
        
        # Display user info
        echo -e "${WHITE}User: ${GREEN}$USER_TYPE${NC} | ${WHITE}Directory: ${GREEN}$RPC_DIR${NC}"
        echo ""
        
        # Display requirements
        echo -e "${YELLOW}ğŸ“‹ System Requirements:${NC}"
        echo ""
        
        # RAM Check
        if [ "$RAM_GB" -ge 16 ]; then
            echo -e "  ${WHITE}RAM:${NC}     Required: 16GB   â”‚   ${GREEN}You have: ${RAM_GB}GB âœ“${NC}"
        elif [ "$RAM_GB" -ge 8 ]; then
            echo -e "  ${WHITE}RAM:${NC}     Required: 16GB   â”‚   ${YELLOW}You have: ${RAM_GB}GB âš ${NC}"
        else
            echo -e "  ${WHITE}RAM:${NC}     Required: 16GB   â”‚   ${RED}You have: ${RAM_GB}GB âœ—${NC}"
        fi
        
        # Cores Check
        if [ "$CORES" -ge 4 ]; then
            echo -e "  ${WHITE}Cores:${NC}   Required: 4      â”‚   ${GREEN}You have: ${CORES} âœ“${NC}"
        else
            echo -e "  ${WHITE}Cores:${NC}   Required: 4      â”‚   ${YELLOW}You have: ${CORES} âš ${NC}"
        fi
        
        # Storage Check
        echo -e "  ${WHITE}Storage:${NC} Required: 1TB    â”‚   ${CYAN}Total: ${STORAGE_GB}GB | Free: ${STORAGE_FREE}GB${NC}"
        echo ""
        
        # Quick status
        echo -e "${WHITE}RPC Status:${NC}"
        if [ -d "$RPC_DIR" ]; then
            if $DOCKER_CMD ps 2>/dev/null | grep -q "geth"; then
                echo -e "${GREEN}â— Installed and Running${NC}"
            else
                echo -e "${YELLOW}â— Installed but Stopped${NC}"
            fi
        else
            echo -e "${RED}â— Not Installed${NC}"
        fi
        
        # Docker group status for non-root users
        if [ "$USER_TYPE" != "root" ]; then
            if groups | grep -q docker; then
                echo -e "${GREEN}â— Docker group: Yes${NC}"
            else
                echo -e "${YELLOW}â— Docker group: No (using sudo)${NC}"
            fi
        fi
        
        echo -e "\n${PURPLE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•[ ${WHITE}MENU OPTIONS${NC} ${PURPLE}]â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
        echo -e "  ${CYAN}[${WHITE}1${CYAN}]${NC} ${WHITE}ğŸš€ Install RPC (Geth & Prysm)${NC}"
        echo -e "  ${CYAN}[${WHITE}2${CYAN}]${NC} ${WHITE}ğŸ“Š Sync Checkup${NC}"
        echo -e "  ${CYAN}[${WHITE}3${CYAN}]${NC} ${WHITE}ğŸ“œ RPC Connection Info & Logs${NC}"
        echo -e "  ${CYAN}[${WHITE}4${CYAN}]${NC} ${WHITE}ğŸ—‘ï¸  Delete RPC Node${NC}"
        echo -e "  ${CYAN}[${WHITE}5${CYAN}]${NC} ${WHITE}ğŸšª Exit${NC}"
        
        echo -e "\n${AMBER}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        read -p "Select option [1-5]: " choice
        
        case $choice in
            1)
                install_rpc
                ;;
            2)
                check_sync
                ;;
            3)
                view_rpc
                ;;
            4)
                delete_rpc
                ;;
            5)
                echo -e "\n${CYAN}Thanks for using RPC Manager!${NC}"
                echo -e "${WHITE}Goodbye ğŸ‘‹${NC}\n"
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid option. Please choose between 1-5.${NC}"
                sleep 2
                ;;
        esac
    done
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCRIPT INITIALIZATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Initial welcome message
clear
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘     SEPOLIA RPC MANAGER - INITIALIZING...             â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Display system information
echo -e "${WHITE}System Information:${NC}"
echo -e "  â€¢ OS: $(lsb_release -ds 2>/dev/null || cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
echo -e "  â€¢ Kernel: $(uname -r)"
echo -e "  â€¢ Architecture: $(uname -m)"
echo -e "  â€¢ Hostname: $(hostname)"
echo ""

# Check if running with sudo
if [ -n "$SUDO_USER" ]; then
    echo -e "${YELLOW}âš ï¸  Running with sudo as user: $SUDO_USER${NC}"
fi

# Check Docker on startup
echo -e "${CYAN}Checking Docker installation...${NC}"
check_docker

# Ensure docker daemon is running
if ! ${SUDO_CMD} systemctl is-active --quiet docker; then
    echo -e "${YELLOW}Starting Docker service...${NC}"
    ${SUDO_CMD} systemctl start docker
    sleep 2
fi

# For non-root users, check docker permissions
if [ "$EUID" -ne 0 ]; then
    if ! groups | grep -q docker; then
        echo -e "\n${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${YELLOW}IMPORTANT: Docker Permission Setup${NC}"
        echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${WHITE}You're not in the docker group yet.${NC}"
        echo -e "${WHITE}To avoid using sudo for docker commands:${NC}"
        echo -e "${CYAN}1. Run: ${WHITE}sudo usermod -aG docker $USER${NC}"
        echo -e "${CYAN}2. Then: ${WHITE}newgrp docker${NC}"
        echo -e "${CYAN}   OR logout and login again${NC}"
        echo -e "${YELLOW}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${WHITE}For now, docker commands will use sudo.${NC}"
        read -p "Press Enter to continue..."
    fi
fi

# Ready message
echo -e "\n${GREEN}âœ… Initialization complete!${NC}"
sleep 1

# Start main menu
main_menu

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# END OF SCRIPT
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
